---
# bootstrap.yml has to be run before this playbook
- name: Setup for all hosts
  hosts: all
  pre_tasks:
    - name: Update apt cache
      become: yes
      apt:
        update_cache: yes
        cache_valid_time: 3600
      when: ansible_facts.distribution == "Debian"

    - name: Update pacman cache
      become: yes
      pacman:
        update_cache: yes
      changed_when: false
      when: ansible_facts.distribution == "Archlinux"

  roles:
    - networking
    - hostname
    - locale
    - timezone
    - ntp
    - users
    - system-mail
    - sshd
    - ssh-client
    - ssh-keys
    - dotfiles
    - vim
    - sensors
    - role: package-group
      package_group: "base_utils"
    - role: package-group
      package_group: "net_utils"
    - role: package-group
      package_group: "system_utils"
    - role: package-group
      package_group: "development_utils"
    - role: package-group
      aur_package_group: "development_utils"

- hosts: archlinux
  gather_facts: no
  roles:
    - bootloader
    - hddtemp
    - sysctl
    - journald
    - firewall
    - makepkg
    - system-maintenance
    - global-aliases
    - misc-setup
    - xdg-dirs
    - docker
    - { role: backup-duplicity-docker, when: duplicity is defined }
    - fuse
    - { role: packages, packages: "{{ host_packages }}" }
    - { role: services, services: "{{ host_services }}" }
    - { role: packages-uninstalled, packages: "{{ host_uninstalled_packages }}" }

- hosts: desktop
  gather_facts: no
  roles:
    - sound
    - { role: xorg, when: display_server == 'x11' }
    - { role: wayland, when: display_server == 'wayland', tags: ['wayland'] }
    - { role: lightdm, when: desktop_environment != 'gnome' }
    - role: package-group
      package_group: "desktop"
    - role: package-group
      aur_package_group: "desktop"
    - fonts
    - { role: cinnamon, when: desktop_environment == 'cinnamon' }
    - { role: gnome, when: desktop_environment == 'gnome', tags: ['gnome'] }
    - { role: conky, when: display_server == 'x11' }
    - solaar
    - signal-desktop
    - zim
    - weechat
    - node
    - firefox
    - systemd-user-units
    - terminal
    - cups
    - { role: devilspie, when: display_server == 'x11' }
    - spotify
    - desktop
    - yubikey
    - { role: bluetooth, when: has_bluetooth is defined }
  tasks:
    - name: Ensure files does not exist
      file:
        path: "{{ item }}"
        state: absent
      with_items:
        - "{{ ansible_user_dir }}/.config/xfce"
        - "{{ ansible_user_dir }}/.xfce4-session.verbose-log"
        - "{{ ansible_user_dir }}/.config/autostart/xfce4-settings-helper-autostart.desktop"
        - "{{ ansible_user_dir }}/.config/autostart/xfce4-tips-autostart.desktop"
        - "{{ ansible_user_dir }}/.config/autostart/xfce4-power-manager.desktop"
        - "{{ ansible_user_dir }}/.yaourtrc"

- hosts: gaming
  gather_facts: no
  roles:
    - gaming

- hosts: htpc
  gather_facts: no
  roles:
    - kodi-shutdown-check
    - unifi-controller-backup
    - getmail
    - backup-rclone
    - photoprism

- hosts: laptop
  gather_facts: no
  roles:
    - powersave
    - bluetooth
    - apparmor
    - secureboot

- hosts: thinkpad
  gather_facts: no
  roles:
    - thinkpad
    - samba-client

- hosts: macbook
  gather_facts: no

  pre_tasks:
    - name: Ensure mbpfan is installed
      become: yes
      become_user: aur_builder
      aur:
        name: mbpfan-git
  roles:
    - { role: services, services: ['mbpfan'] }

- hosts: raspberrypi
  gather_facts: no
  roles:
    - raspbian
    - arpwatch
    - docker

- hosts: unifi-controller
  gather_facts: no
  roles:
    - unifi-controller
