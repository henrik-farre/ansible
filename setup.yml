---
- hosts: all
  pre_tasks:
    - name: Update apt cache
      become: yes
      apt:
        update_cache: yes
        cache_valid_time: 3600
      when: ansible_facts.distribution == "Debian"

    - name: Update pacman cache
      become: yes
      pacman:
        update_cache: yes
      changed_when: false
      when: ansible_facts.distribution == "Archlinux"

  roles:
    - networking
    - hostname
    - locale
    - timezone
    - ntp
    - users
    - system-mail
    - sshd
    - ssh-client
    - ssh-keys
    - dotfiles
    - vim
    - sensors
    - role: package-group
      package_group: "base_utils"
    - role: package-group
      package_group: "net_utils"
    - role: package-group
      package_group: "system_utils"
    - role: package-group
      package_group: "development_utils"

- hosts: archlinux
  roles:
    - modules
    - cron
    - hddtemp
    - sysctl
    - journald
    - firewall
    - makepkg
    - system-maintenance
    - global-aliases
    - misc-setup
    - xdg-dirs
    - docker
    - { role: backup-duplicity-docker, when: duplicity is defined }
    - php
    - fuse
    - { role: packages, packages: "{{ host_packages }}" }
    - { role: services, services: "{{ host_services }}" }
    - { role: packages-uninstalled, packages: "{{ host_uninstalled_packages }}" }

- hosts: desktop
  roles:
    - xorg
    - lightdm
    - role: package-group
      package_group: "desktop"
    - fonts
    - cinnamon
    - conky
    - zim
    - node
    - firefox
    - xcape
    - systemd-user-units
    - terminal
    - cups
    - devilspie
    - spotify
  tasks:
    - name: Install packages from AUR
      become: yes
      become_user: aur_builder
      aur:
        name: "{{ aur_packages }}"
      when: aur_packages|length > 0
    - name: Ensure esound support is disabled in pulseaudio
      become: yes
      replace:
        path: /etc/pulse/default.pa
        regexp: '^(#*)\.ifexists module-esound-.*\n(#*)load-module.*\n(#*)\.endif'
        replace: '# esound disabled by Ansible'
    - name: Ensure files does not exist
      file:
        path: "{{ item }}"
        state: absent
      with_items:
        - "{{ ansible_user_dir }}/.config/xfce"
        - "{{ ansible_user_dir }}/.xfce4-session.verbose-log"
        - "{{ ansible_user_dir }}/.config/autostart/xfce4-settings-helper-autostart.desktop"
        - "{{ ansible_user_dir }}/.config/autostart/xfce4-tips-autostart.desktop"
        - "{{ ansible_user_dir }}/.config/autostart/xfce4-power-manager.desktop"
        - "{{ ansible_user_dir }}/.yaourtrc"

- hosts: htpc
  roles:
    - kodi-shutdown-check
    - unifi-controller-backup
    - getmail

- hosts: laptop
  roles:
    - powersave
    - bluetooth

- hosts: thinkpad
  roles:
    - thinkpad
    - samba-client

- hosts: macbook
  pre_tasks:
    - name: Ensure mbpfan is installed
      become: yes
      become_user: aur_builder
      aur:
        name: mbpfan-git
  roles:
    - { role: services, services: ['mbpfan'] }

- hosts: raspberrypi
  roles:
    - raspbian
    - arpwatch
    - docker

- hosts: unifi-controller
  roles:
    - unifi-controller
