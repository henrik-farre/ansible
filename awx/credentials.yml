---
- name: Provision AWX | Ensure credentials exist
  hosts: localhost
  connection: local

  tasks:
    - name: Load vaulted vars
      include_vars:
        file: vars/credentials.yml.vault

    - name: Ensure credentials exist
      tower_credential:
        name: "{{ item.name }}"
        description: "{{ item.description }}"
        kind: "{{ item.kind }}"
        organization: "{{ item.organization|default(default_org) }}"
        username: "{{ item.username|default(omit) }}"
        password: "{{ item.password|default(omit) }}"
        ssh_key_data: "{{ item.ssh_key_data|default(omit) }}"
        ssh_key_unlock: "{{ item.ssh_key_unlock|default(omit) }}"
        vault_password: "{{ item.vault_password|default(omit) }}"
        become_password: "{{ item.become_password|default(omit) }}"
        become_method: "{{ item.become_method|default(omit) }}"
        state: present
        tower_config_file: "~/.tower_cli.cfg"
      with_items:
        - "{{ tower_credentials }}"
      no_log: true
