---
- name: Ensure needed packages for xorg are installed
  become: yes
  pacman:
    state: latest
    name: "{{ packages }}"
  vars:
    packages:
      - xkeyboard-config
      - xorg-fonts-encodings
      - xorg-mkfontdir
      - xorg-mkfontscale
      - xorg-server
      - xorg-server-common
      - xorg-setxkbmap
      - xorg-xauth
      - xorg-xdpyinfo
      - xorg-xev
      - xorg-xinit
      - xorg-xinput
      - xorg-xkbcomp
      - xorg-xkill
      - xorg-xmodmap
      - xorg-xprop
      - xorg-xrandr
      - xorg-xrdb
      - xorg-xset
      - xorgproto

- name: Ensure unused packages for xorg are removed
  become: yes
  pacman:
    state: absent
    name: "{{ packages }}"
  vars:
    packages:
      - compositeproto
      - damageproto
      - dmxproto
      - fixesproto
      - fontsproto
      - xineramaproto
      - xorg-fonts-misc
      - xorg-iceauth
      - xorg-server-utils
      - xorg-sessreg
      - xorg-smproxy
      - xorg-utils
      - xorg-x11perf
      - xorg-xbacklight
      - xorg-xcmsdb
      - xorg-xcursorgen
      - xorg-xdriinfo
      - xorg-xgamma
      - xorg-xhost
      - xorg-xkb-utils
      - xorg-xkbevd
      - xorg-xkbutils
      - xorg-xlsatoms
      - xorg-xlsclients
      - xorg-xpr
      - xorg-xrefresh
      - xorg-xsetroot
      - xorg-xvinfo
      - xorg-xwd
      - xorg-xwininfo
      - xorg-xwud
      - xproto

- name: Setup keyboard
  become: yes
  copy:
    src: etc/X11/xorg.conf.d/20-keyboard.conf
    dest: /etc/X11/xorg.conf.d/20-keyboard.conf
    owner: root
    group: root
    mode: 0644
  tags:
    - xorg

- name: Install Intel video driver
  become: yes
  pacman:
    name: "{{ packages }}"
    state: latest
  vars:
    packages:
      - xf86-video-intel
      - libva-intel-driver
      - libva-vdpau-driver
      - libvdpau-va-gl
  when:
    - ansible_local.hardware.vga_vendor == "Intel Corporation"
  tags:
    - xorg

- name: Install Nvidia video driver
  become: yes
  pacman:
    name: "{{ packages }}"
    state: latest
  vars:
    packages:
      - nvidia-dkms
      - libvdpau
      - nvidia-settings
      - nvidia-utils
  when:
    - ansible_local.hardware.vga_vendor == "NVIDIA Corporation"
  tags:
    - xorg

- name: Install AMD video driver
  become: yes
  pacman:
    name: "{{ packages }}"
    state: latest
  vars:
    packages:
      - xf86-video-amdgpu
      - libva-mesa-driver
      - mesa-vdpau
      - vulkan-icd-loader
      - vulkan-radeon
      - lib32-libva-mesa-driver
      - lib32-mesa-vdpau
      - lib32-vulkan-icd-loader
      - lib32-vulkan-radeon
  when:
    - ansible_local.hardware.vga_vendor == "Advanced Micro Devices, Inc. [AMD/ATI]"
  tags:
    - xorg
