---
- name: Include pacman tasks
  include_tasks: pacman.yml
  tags:
    - pacman-mirrors
    - system-maintenance

- name: Include smartd tasks
  include_tasks: smartd.yml
  tags:
    - system-maintenance

- name: Include alsa tasks
  include_tasks: alsa.yml
  tags:
    - system-maintenance

# TODO: better when check instead of hostname
- name: Ensure RAID is checked monthly
  become: yes
  copy:
    src: cron.monthly/raid_maintenance
    dest: /etc/cron.monthly/raid_maintenance
    owner: root
    group: root
    mode: 0750
  tags:
    - system-maintenance
  when:
    - ansible_hostname == "spookcentral"

# I looks like trim should also be called on nvme drives
# - name: Ensure list of nvme devices is reset
#   set_fact:
#     nvme_devices: []
#   tags:
#     - system-maintenance

# - name: Build list of nvme devices
#   set_fact:
#     nvme_devices: "{{ nvme_devices|default([]) + ['/dev/' ~ item.key] }}"
#   with_dict: "{{ ansible_devices }}"
#   when:
#     - item.key[:4] == "nvme"
#   tags:
#     - system-maintenance
#   no_log: True

- name: Ensure fstrim timer is started on supported devices
  become: yes
  systemd:
    name: fstrim.timer
    state: started
    enabled: yes
  tags:
    - system-maintenance

- name: Ensure fstrim timer is disabled on unsupported devices
  become: yes
  systemd:
    name: fstrim.timer
    state: stopped
    enabled: no
  tags:
    - system-maintenance

- name: Ensure cronjob is configured
  become: yes
  cron:
    cron_file: clean-user-cache
    job: find {{ ansible_user_dir }}/.cache -mtime +7 -type f -delete
    special_time: daily
    user: root
    name: "Clean user ~/.cache directory"
  tags:
    - system-maintenance
