---
- name: Ensure environment config dir exists
  ansible.builtin.file:
    path: "{{ ansible_user_dir }}/.config/environment.d/"
    mode: 0750
    state: directory

- name: Ensure QT is configured for wayland
  ansible.builtin.copy:
    dest: "{{ ansible_user_dir }}/.config/environment.d/qt-wayland.conf"
    mode: 0640
    content: "QT_QPA_PLATFORM=wayland"

- name: Ensure Electron is configured for wayland
  ansible.builtin.copy:
    dest: "{{ ansible_user_dir }}/.config/electron-flags.conf"
    mode: 0640
    content: |
      --enable-features=UseOzonePlatform
      --ozone-platform=wayland

# Remember to enable: chrome://flags/#enable-webrtc-pipewire-capturer
- name: Ensure Chromium is configured for wayland
  ansible.builtin.copy:
    dest: "{{ ansible_user_dir }}/.config/chromium-flags.conf"
    mode: 0640
    content: |
      --enable-features=UseOzonePlatform
      --ozone-platform=wayland

- name: Ensure required packages are installed
  become: yes
  pacman:
    name: "{{ packages }}"
    state: latest
  vars:
    packages:
      - wl-clipboard
      - qt5-wayland
      - xorg-xlsclients
      - xdg-desktop-portal-gtk # Needed for WebRTC screen sharing

# https://linuxreviews.org/Intel_graphics#Hardware_Video_Decoding_.2F_Encoding
- name: Install Intel related packages
  become: yes
  pacman:
    name: "{{ packages }}"
    state: latest
  vars:
    packages:
      - libva-vdpau-driver
      - libvdpau-va-gl
      - vulkan-intel
      - libva-utils
      - intel-media-driver # Replaces libva-intel-driver for newer cpus
  when:
    - "'Intel Corporation' in {{ ansible_facts.ansible_local.hardware.video|map(attribute='vendor')|list }}"
