---
- name: Ensure UPS is configured
  become: true
  tags:
    - ups
  block:
    - name: Ensure vaulted vars are loaded
      ansible.builtin.include_vars:
        file: ups.yml.vault

    - name: Ensure dependencies for UPS is installed
      community.general.pacman:
        name: nut
        state: latest

    - name: Ensure UPS is configured
      ansible.builtin.blockinfile:
        path: /etc/nut/ups.conf
        block: |
          [cyberpower-vp700elcd]
            driver = "usbhid-ups"
            port = "auto"
            vendorid = "0764"
            productid = "0501"
            product = "VP700ELCD"
            vendor = "CPS"
            pollonly = "enabled"

    # Needed for home assistant integration
    - name: Ensure netserver mode is enabled
      ansible.builtin.lineinfile:
        name: /etc/nut/nut.conf
        regexp: '^MODE='
        line: 'MODE=netserver'
        state: present

    - name: Ensure LISTEN address is set securely
      ansible.builtin.lineinfile:
        path: /etc/nut/upsd.conf
        regexp: '^#?\s*LISTEN\s+127'
        line: 'LISTEN 127.0.0.1 3493'
        state: present

    - name: Ensure UPS users are configured
      no_log: True
      ansible.builtin.blockinfile:
        path: /etc/nut/upsd.users
        block: |
          {% for user in ups.users %}
          [{{ user.name }}]
            password = {{ user.password }}
            upsmon {{ user.mode }}
          {% endfor %}

    - name: Ensure monitoring is configured
      ansible.builtin.blockinfile:
        path: /etc/nut/upsmon.conf
        block: |
          {% for user in ups.users %}
          {% if user.mode == "primary" %}
          MONITOR cyberpower-vp700elcd@localhost 1 {{ user.name }} {{ user.password }} {{ user.mode }}
          {% endif %}
          {% endfor %}

    - name: Ensure monitoring is running as non root
      ansible.builtin.lineinfile:
        path: /etc/nut/upsmon.conf
        regexp: '^#?\s*RUN_AS_USER.*'
        line: 'RUN_AS_USER nut'
        state: present

    - name: Enable services and targets
      ansible.builtin.systemd:
        name: "{{ item }}"
        state: started
        enabled: true
      loop:
        - nut.target
        - nut-driver.target
        - nut-server.service
        - nut-driver-enumerator.service
