---
- name: Ensure vaulted vars are loaded
  ansible.builtin.include_vars:
    file: backup_duplicity.yml.vault

- name: Ensure ~root/.ssh exists
  ansible.builtin.file:
    path: /root/.ssh
    group: root
    state: directory
    mode: 0700
    owner: root
  tags:
    - backup

- name: Install ssh keys
  ansible.builtin.copy:
    src: "root/dot.ssh/{{ item }}.vault"
    dest: "/root/.ssh/{{ item }}"
    owner: root
    group: root
    mode: 0400
  with_items:
    - id_rsa.backup
    - id_rsa.backup.pub
  tags:
    - backup

- name: Ensure ssh config exists for backup host
  ansible.builtin.blockinfile:
    dest: "/root/.ssh/config"
    create: yes
    block: "{{ ssh_config }}"
    marker: "# {mark} ANSIBLE MANAGED BLOCK backup_host"
    mode: 0400
  vars:
    ssh_config: "{{ vaulted_backup_duplicity_ssh_config }}"
  tags:
    - backup

- name: Import ssh host key
  ansible.builtin.known_hosts:
    path: /root/.ssh/known_hosts
    name: "{{ duplicity.remote_host }}"
    key: "{{ lookup('pipe', 'ssh-keyscan -t rsa {{ duplicity.remote_host }}') }}"
  tags:
    - backup
