---
- block:
  - name: Include cleanup tasks
    include_tasks: cleanup.yml
    tags:
      - backup

  - name: Ensure directory exist
    become: true
    file:
      path: /usr/local/etc/duplicity-docker
      mode: 0750
      owner: root
      group: docker
      state: directory
    tags:
      - backup

    # Note "cmd" is for running other actions like "list", e.g.:
    # docker-compose -f duplicity-cmd.yml run --rm duplicity list home
  - name: Ensure docker compose files exists for current host
    become: true
    template:
      src: "usr/local/etc/duplicity-docker/duplicity.yml.j2"
      dest: "/usr/local/etc/duplicity-docker/duplicity-{{ item }}.yml"
      mode: 0640
      owner: root
      group: docker
    with_items:
      - backup
      - clean
      - remove-old-inc
      - remove-old-set
      - cmd
    tags:
      - backup

  - name: Install directory excludes
    become: true
    copy:
      src: "excludes/{{ item.src }}"
      dest: "{{ item.dest }}/.duplicity_exclude"
      owner: root
      mode: 0400
    with_items:
      - "{{ duplicity.excludes }}"
    when:
      - duplicity.excludes is defined
    tags:
      - backup

  - name: Ensure failed service email script exists
    become: true
    copy:
      content: |
        #!/bin/bash

        /usr/bin/sendmail -t <<ERRMAIL
        To: $1
        From: systemd on $HOSTNAME <root@$HOSTNAME>
        Subject: $2
        Content-Transfer-Encoding: 8bit
        Content-Type: text/plain; charset=UTF-8

        $(systemctl status --full "$2")
        ERRMAIL
      dest: /usr/local/bin/systemd-email
      mode: 0750
      owner: root
      group: mail
    tags:
      - backup

  - name: Ensure failed service unit exists
    become: true
    copy:
      content: |
        [Unit]
        Description=status email for %i to user

        [Service]
        Type=oneshot
        ExecStart=/usr/local/bin/systemd-email henrik.farre@gmail.com %i
        User=root
        Group=systemd-journal
      dest: /etc/systemd/system/status-email-enrique@.service
      mode: 0644
      owner: root
    tags:
      - backup

  - name: Include ssh setup tasks
    include_tasks: ssh_setup.yml

  - name: Include gpg setup tasks
    include_tasks: gpg_setup.yml

  - name: Install systemd services
    become: true
    template:
      src: "etc/systemd/system/duplicity-docker-tpl.service.j2"
      dest: "/etc/systemd/system/duplicity-docker-{{ item }}.service"
      owner: root
      mode: 0644
    with_items:
      - backup
      - clean
      - remove-old-inc
      - remove-old-set
    tags:
      - backup

  - name: Install systemd timers
    become: true
    template:
      src: "etc/systemd/system/duplicity-docker-tpl.timer.j2"
      dest: "/etc/systemd/system/duplicity-docker-{{ item }}.timer"
      owner: root
      mode: 0644
    with_items:
      - backup
      - clean
      - remove-old-inc
      - remove-old-set
    tags:
      - backup

  - name: Enable systemd services
    become: true
    systemd:
      name: "duplicity-docker-{{ item }}.service"
      enabled: yes
      daemon_reload: yes
    with_items:
      - backup
      - clean
      - remove-old-inc
      - remove-old-set
    tags:
      - backup

  - name: Enable systemd timers
    become: true
    systemd:
      name: "duplicity-docker-{{ item }}.timer"
      enabled: yes
      state: started
      daemon_reload: yes
    with_items:
      - backup
      - clean
      - remove-old-inc
      - remove-old-set
    tags:
      - backup

  always:
    - name: Ensure latest docker image is pulled
      docker_image:
        name: rockhopperdk/duplicity-docker:latest
        force: yes
      tags:
        - backup

    - name: Cleanup git clone
      file:
        path: /tmp/dupebackup
        state: absent
      delegate_to: localhost
      tags:
        - backup

    - name: Cleanup gpg keys
      become: true
      file:
        path: "/root/.gnupg/private.asc"
        state: absent
      tags:
        - backup

    - name: Cleanup ownertrust
      become: true
      file:
        path: "/root/.gnupg/ownertrust"
        state: absent
      tags:
        - backup
