---
- name: Ensure home assistant is installed and configured
  become: true
  tags:
    - home-assistant
  block:
    - name: Ensure vaulted vars are loaded
      ansible.builtin.include_vars:
        file: homeassistant.yml.vault

    - name: Ensure correct bluetooth firmware is installed
      ansible.builtin.get_url:
        url: https://github.com/RPi-Distro/bluez-firmware/blob/master/broadcom/BCM4345C0.hcd?raw=true
        dest: /lib/firmware/brcm/BCM4345C0.hcd
        checksum: sha256:8b3ef20cc40f4cad64f7acd98f9e9d4e5401252836f190388aa5c9c0b7e30648
        owner: root
        group: root
        mode: 0644

    - name: Ensure needed packages for bluetooth support are installed
      ansible.builtin.apt:
        name: "{{ packages }}"
        state: latest
      vars:
        packages:
          - dbus-broker
          - bluetooth

    - name: Ensure dbus-broker is enabled
      ansible.builtin.systemd:
        name: dbus-broker
        state: started
        enabled: true
      notify: Reboot host

    - name: Ensure needed directories exist
      ansible.builtin.file:
        path: "/srv/home-assistant/{{ item.path }}"
        state: directory
        mode: 0775
        owner: "{{ item.owner }}"
        group: "{{ item.group }}"
      loop:
        - path: data/home-assistant/config
          owner: root
          group: docker
        - path: data/mariadb/mysql
          owner: 999
          group: 999
        - path: data/mariadb/entrypoint
          owner: root
          group: docker
        - path: data/mosquitto/config
          owner: 1883
          group: 1883
        - path: data/mosquitto/data
          owner: 1883
          group: 1883
        - path: data/mosquitto/log
          owner: 1883
          group: 1883
        - path: data/zigbee2mqtt
          owner: root
          group: docker
        - path: deploy
          owner: root
          group: docker

    - name: Ensure mosquitto is configured
      ansible.builtin.copy:
        dest: /srv/home-assistant/data/mosquitto/config/mosquitto.conf
        content: |
          listener 1883
          persistence true
          persistence_location /mosquitto/data

          log_dest stdout

          ## Authentication ##
          allow_anonymous false
          password_file /mosquitto/config/password_file
        mode: 0664
        owner: 1883
        group: 1883

    - name: Ensure mosquitto has password_file
      ansible.builtin.template:
        dest: /srv/home-assistant/data/mosquitto/config/password_file
        src: mosquitto_password_file.j2
        mode: 0400
        owner: 1883
        group: 1883

    - name: Ensure zigbee2mqtt is configured
      ansible.builtin.blockinfile:
        path: /srv/home-assistant/data/zigbee2mqtt/configuration.yaml
        marker: "# {mark} ANSIBLE MANAGED BLOCK zigbee2mqtt-base-config"
        create: true
        content: |
          ---
          permit_join: true
          mqtt:
            base_topic: zigbee2mqtt
            server: mqtt://mosquitto
            user: {{ homeassistant.mosquitto.user }}
            password: {{ homeassistant.mosquitto.password }}
          serial:
            adapter: ezsp
            port: >-
              /dev/serial/by-id/usb-ITEAD_SONOFF_Zigbee_3.0_USB_Dongle_Plus_V2_20220811181030-if00
          frontend:
            port: 8080
          homeassistant: true
        mode: 0664
        owner: 1883
        group: docker

    - name: Ensure docker-compose.yml exists for home assistant
      ansible.builtin.template:
        src: docker-compose.yml.j2
        dest: /srv/home-assistant/deploy/docker-compose.yml
        mode: 0664
        owner: root
        group: docker

    - name: Deploy Docker Compose stack
      community.docker.docker_compose:
        project_name: home-assistant
        project_src: /srv/home-assistant/deploy

    - name: Custom traefik config
      ansible.builtin.template:
        src: traefik/home-assistant.yml.j2
        dest: /srv/traefik/data/dynamic/home-assistant.yml
        mode: 0664
        owner: root
        group: docker

    - name: Wait until the file /tmp/foo is present before continuing
      ansible.builtin.wait_for:
        path: /srv/home-assistant/data/home-assistant/config/configuration.yaml

    - name: Ensure external db is used for recorder
      ansible.builtin.blockinfile:
        path: /srv/home-assistant/data/home-assistant/config/configuration.yaml
        marker: "# {mark} ANSIBLE MANAGED BLOCK recorder"
        owner: root
        group: docker
        mode: 0660
        block: |
          recorder:
            # https://www.home-assistant.io/integrations/recorder/
            # Connecting using shared socket in volume
            db_url: mysql://{{ homeassistant.db.user }}:{{ homeassistant.db.password }}@localhost/{{ homeassistant.db.database }}?unix_socket=/var/run/mysqld/mysqld.sock&charset=utf8mb4
      notify: Restart home-assistant container

    - name: Get infos on network
      community.docker.docker_network_info:
        name: traefik
      register: traefik_network

    - name: Ensure http is configured
      ansible.builtin.blockinfile:
        path: /srv/home-assistant/data/home-assistant/config/configuration.yaml
        marker: "# {mark} ANSIBLE MANAGED BLOCK http"
        block: |
          # https://www.home-assistant.io/integrations/http/
          http:
            ip_ban_enabled: true
            login_attempts_threshold: 5
            use_x_forwarded_for: true
            trusted_proxies:
              - 192.168.0.0/24
              - 172.17.0.0/24
              - {{ traefik_network.network.IPAM.Config[0].Subnet }}
              - 127.0.0.1
              - ::1
              - fe80::/64
              - fe00::/64
              - fd00::/64
      notify: Restart home-assistant container

    - name: Ensure bluetooth is enabled
      ansible.builtin.blockinfile:
        path: /srv/home-assistant/data/home-assistant/config/configuration.yaml
        marker: "# {mark} ANSIBLE MANAGED BLOCK bluetooth"
        block: |
          # https://www.home-assistant.io/integrations/bluetooth/
          bluetooth:
      notify: Restart home-assistant container

# hacs install
# run inside data/config folder
# https://raw.githubusercontent.com/hacs/get/main/get
