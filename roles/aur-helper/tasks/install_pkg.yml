---
- name: Build package
  block:
    - name: Set build dir
      set_fact:
        build_dir: "{{ ansible_user_dir }}/tmp/{{ aur_pkg_helper }}"

    - name: Ensure clean build dir
      file:
        path: "{{ build_dir }}"
        state: absent
      tags:
        - aur-helper

    - name: Check if package "{{ aur_pkg_helper }}" is installed
      stat:
        path: "{{ aur_pkg_helper_path }}"
      register: stat_pkg
      tags:
        - aur-helper

    - name: Git clone "{{ aur_pkg_helper }}"
      git:
        repo: https://aur.archlinux.org/{{ aur_pkg_helper }}.git
        dest: "{{ build_dir }}"
        accept_hostkey: yes
        version: master
      when: not stat_pkg.stat.exists
      tags:
        - aur-helper

    - name: Build "{{ aur_pkg_helper }}" using makepkg
      command: makepkg -si --noconfirm --noprogressbar
      args:
        chdir: "{{ build_dir }}"
        creates: "{{ aur_pkg_helper_path }}"
      when: not stat_pkg.stat.exists
      tags:
        - aur-helper

  always:
    - name: Ensure no files are left after building
      file:
        path: "{{ build_dir }}"
        state: absent
      tags:
        - aur-helper
