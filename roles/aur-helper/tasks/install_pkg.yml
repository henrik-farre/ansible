---
- name: Build package
  block:
    - name: Set build dir
      set_fact:
        build_dir: "{{ ansible_user_dir }}/tmp/{{ aur_pkg }}"

    - name: Ensure clean build dir
      file:
        path: "{{ build_dir }}"
        state: absent
      tags:
        - aur-helper

    - name: Check if package "{{ aur_pkg }}" is installed
      stat:
        path: "{{ aur_pkg_path }}"
      register: stat_pkg
      tags:
        - aur-helper

    - name: Git clone "{{ aur_pkg }}"
      git:
        repo: https://aur.archlinux.org/{{ aur_pkg }}.git
        dest: "{{ build_dir }}"
        accept_hostkey: yes
        version: master
      when:
        - stat_pkg.stat.exists == False
      tags:
        - aur-helper

    - name: Build "{{ aur_pkg }}" using makepkg
      command: makepkg -si --noconfirm --noprogressbar
      args:
        chdir: "{{ build_dir }}"
        creates: "{{ aur_pkg_path }}"
      when:
        - stat_pkg.stat.exists == False
      tags:
        - aur-helper

  always:
    - name: Ensure no files are left after building
      file:
        path: "{{ build_dir }}"
        state: absent
      tags:
        - aur-helper
