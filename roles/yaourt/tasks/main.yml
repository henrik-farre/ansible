---
- name: Check if package-query is installed
  stat:
    path: /usr/bin/package-query
  register: stat_pq
  tags:
    - yaourt

- name: Check if yaourt is installed
  stat:
    path: /usr/bin/yaourt
  register: stat_yaourt
  tags:
    - yaourt

- name: Git clone package-query
  git:
    repo: https://aur.archlinux.org/package-query.git
    dest: "{{ ansible_user_dir }}/package-queue"
    accept_hostkey: yes
  delegate_to: localhost
  when:
    - stat_pq.stat.exists == False
  tags:
    - yaourt

- name: Build package-query using makepkg
  command: makepkg -si
  args:
    chdir: "{{ ansible_user_dir }}/package-queue"
    creates: /usr/bin/package-query
  delegate_to: localhost
  when:
    - stat_pq.stat.exists == False
  register: aur_makepkg_result
  tags:
    - yaourt

- name: Install package-query using pacman
  become: yes
  command: pacman -U "{{ item }}" --noconfirm --noprogressbar
  args:
    creates: /usr/bin/package-query
  with_fileglob:
    - "{{ ansible_user_dir }}/package-queue/package-query-*-x86_64.pkg.tar.xz"
  delegate_to: localhost
  when:
    - aur_makepkg_result|succeeded
  tags:
    - yaourt

- name: Git clone yaourt
  git:
    repo: https://aur.archlinux.org/yaourt.git
    dest: "{{ ansible_user_dir }}/yaourt"
    accept_hostkey: yes
  when:
    - stat_pq.stat.exists == False
  delegate_to: localhost
  tags:
    - yaourt

- name: Build yaourt using makepkg
  command: makepkg -si
  args:
    chdir: "{{ ansible_user_dir }}/yaourt"
    creates: /usr/bin/yaourt
  delegate_to: localhost
  register: aur_makepkg_result
  when:
    - stat_yaourt.stat.exists == False
  tags:
    - yaourt

- name: Install yaourt using pacman
  become: yes
  command: pacman -U "{{ item }}" --noconfirm --noprogressbar
  args:
    creates: /usr/bin/yaourt
  with_fileglob:
    - "{{ ansible_user_dir }}/yaourt/yaourt-*-any.pkg.tar.xz"
  delegate_to: localhost
  when:
    - aur_makepkg_result|succeeded
  tags:
    - yaourt
