---
- name: Ensure users are provisioned
  tags:
    - users
  block:
    # TODO: This overrides the values in the inventory
    - name: Include vaulted vars
      ansible.builtin.include_vars:
        file: users.yml.vault
      no_log: true

    - name: Ensure users shell are installed
      ansible.builtin.include_role:
        name: shell
      vars:
        shells: "{{ users | map(attribute='shell') | list | unique }}"
      when:
        - users is defined

    - name: Ensure users exists
      become: true
      ansible.builtin.user:
        name: "{{ item.name }}"
        shell: "/bin/{{ item.shell | default('bash') }}"
        home: "/{{ users_home_base }}/{{ item.name }}"
        group: "{{ item.group | default('users') }}"
        groups: "{{ item.groups }}"
        comment: "{{ item.comment | default(omit) }}"
        append: yes
        password: "{{ item.password | password_hash('sha512', 65534 | random(seed=inventory_hostname) | string, rounds=10000) }}"
      loop: "{{ users }}"
      when:
        - users is defined
      no_log: true

    # TODO: missing in inventory?
    - name: Ensure users are members of group that allows sudo
      ansible.builtin.user:
        name: "{{ item }}"
        groups: "{%if ansible_facts.distribution == 'Archlinux' %}wheel{% else %}sudo{% endif %}"
        append: yes
      loop: "{{ groups_to_users.sudo }}"
      when:
        - groups_to_users.sudo is defined

    - name: Clean up users
      become: true
      ansible.builtin.user:
        name: "{{ item }}"
        state: absent
        remove: yes
      loop:
        - "cinnamon"
        - "cinnemon"
        - "pi"
