---
- name: Load vaulted vars
  include_vars:
    file: users.vault.yml
  tags:
    - users

- name: Create users
  user:
    name: "{{ item.name }}"
    shell: /bin/zsh
    groups: "{{ item.groups }}"
    password: "{{ item.password }}"
  with_items:
    - "{{ vaulted_user_config }}"
  no_log: yes
  tags:
    - users

- name: Set root password
  user:
    name: root
    password: "{{ vaulted_root_password }}"
  no_log: yes
  tags:
    - users

- name: Clean up users
  user:
    name: "{{ item }}"
    state: absent
    remove: yes
  with_items:
    - "cinnamon"
    - "cinnemon"
  tags:
    - users
