---
- name: Copy pacman-sort-mirrors.sh
  become: yes
  file:
    path: /usr/local/sbin/pacman-sort-mirrors.sh
    state: absent
  tags:
    - pacman-mirrors

- name: Ensure cronjob is configured
  become: yes
  cron:
    state: absent
    cron_file: pacman-mirrors-rank
    job: /usr/local/sbin/pacman-sort-mirrors.sh
    user: root
    special_time: daily
    name: pacman-mirrors-rank
  tags:
    - pacman-mirrors

- name: Ensure pacman mirrorlist hook is present
  become: yes
  copy:
    dest: /etc/pacman.d/hooks/mirrorupgrade.hook
    content: |
      [Trigger]
      Operation = Upgrade
      Type = Package
      Target = pacman-mirrorlist

      [Action]
      Description = Updating mirror list...
      When = PostTransaction
      Depends = reflector
      Exec = /usr/bin/bash -c "/usr/bin/reflector --country Denmark --country Germany --country Norway --country Sweden --country Ireland --country Netherlands --country 'United Kingdom' --fastest 5 --protocol https --sort rate --threads 10 --age 12 --save /etc/pacman.d/mirrorlist && if [[ -f /etc/pacman.d/mirrorlist.pacnew ]]; then rm /etc/pacman.d/mirrorlist.pacnew; fi"
    owner: root
    mode: 0750
  tags:
    - pacman-mirrors
