---
- name: Check updated mirrorlist exists
  stat:
    path: /etc/pacman.d/mirrorlist.pacnew
  register: mirror_file
  tags:
    - pacman-mirrors

- name: Overwrite mirrors with mirrorlist.pacnew (if it exists)
  copy:
    src: /etc/pacman.d/mirrorlist.pacnew
    dest: /etc/pacman.d/mirrorlist
    owner: root
    group: root
    mode: 0644
    backup: yes
  when: mirror_file.stat.exists is defined and mirror_file.stat.exists
  tags:
    - pacman-mirrors

- name: Remove old danish mirrors if mirrorlist.pacnew exists
  file:
    path: /etc/pacman.d/mirrorlist.denmark
    state: absent
  when: mirror_file.stat.exists is defined and mirror_file.stat.exists
  tags:
    - pacman-mirrors

- name: Remove mirrorlist.pacnew
  file:
    path: /etc/pacman.d/mirrorlist.pacnew
    state: absent
  when: mirror_file.stat.exists is defined and mirror_file.stat.exists
  tags:
    - pacman-mirrors

- name: Enable only mirrors from Denmark
  command: grep -A1 --no-group-separator Denmark /etc/pacman.d/mirrorlist > /etc/pacman.d/mirrorlist.denmark
  args:
    creates: /etc/pacman.d/mirrorlist.denmark
  tags:
    - pacman-mirrors

- name: Overwrite default mirror list
  copy:
    src: /etc/pacman.d/mirrorlist.denmark
    dest: /etc/pacman.d/mirrorlist
    owner: root
    group: root
    mode: 0644
    backup: yes
  tags:
    - pacman-mirrors
