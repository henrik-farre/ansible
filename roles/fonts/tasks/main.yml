---
- block:
  - name: Ensure old fontconfig directories are absent
    file:
      path: "{{ ansible_user_dir }}/{{ item }}"
      state: absent
    loop:
      - .fonts
      - .fonts.conf
      - .fonts.conf.d
      - .fontconfig
    tags:
      - fonts

  - name: Enable LCD filter
    become: yes
    file:
      src: /etc/fonts/conf.avail/11-lcdfilter-default.conf
      dest: /etc/fonts/conf.d/11-lcdfilter-default.conf
      state: link
    tags:
      - fonts

  - name: Enable sub-pixel rendering
    become: yes
    file:
      src: /etc/fonts/conf.avail/10-sub-pixel-rgb.conf
      dest: /etc/fonts/conf.d/10-sub-pixel-rgb.conf
      state: link
    tags:
      - fonts

  - name: Enable hinting
    become: yes
    file:
      src: /etc/fonts/conf.avail/10-hinting-slight.conf
      dest: /etc/fonts/conf.d/10-hinting-slight.conf
      state: link
    tags:
      - fonts

  - name: Create fonts directory
    file:
      path: "{{ ansible_user_dir }}/.local/share/fonts"
      owner: "{{ ansible_user_id }}"
      state: directory
      mode: 0700
    tags:
      - fonts

  - name: Check if Mononoki is installed
    stat:
      path: "{{ ansible_user_dir }}/.local/share/fonts/mononoki-Regular.ttf"
    register: font_stat
    tags:
      - fonts

  - name: Download mononoki font
    git:
      repo: https://github.com/madmalik/mononoki.git
      dest: /tmp/mononoki
      version: master
    when:
      - font_stat.stat.exists is defined and not font_stat.stat.exists
    tags:
      - fonts

  # http://stackoverflow.com/a/35650167
  - name: Install mononoki font
    copy:
      src: "/tmp/mononoki/export/webfont/{{ item }}"
      dest: "{{ ansible_user_dir }}/.local/share/fonts/{{ item }}"
      remote_src: yes
    loop:
      - "mononoki-BoldItalic.ttf"
      - "mononoki-Italic.ttf"
      - "mononoki-Bold.ttf"
      - "mononoki-Regular.ttf"
    when:
      - font_stat.stat.exists is defined and not font_stat.stat.exists
    notify:
      - Update font cache
    tags:
      - fonts

  always:
    - name: Cleanup
      file:
        path: /tmp/mononoki
        state: absent
      tags:
        - fonts
