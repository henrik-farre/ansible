---
- name: Ensure power saving is configured
  become: yes
  tags:
    - powersave
  block:
    - name: Copy udev rules for saving power
      ansible.builtin.copy:
        dest: "/etc/udev/rules.d/{{ item }}"
        src: "etc/udev/rules.d/{{ item }}"
      loop:
        - 50-usb_power_save.rules
        - 51-pci_powermanagement.rules
        - 55-powerprofilectl.rules

    - name: Ensure powersave profile daemon is installed
      pacman:
        name: power-profiles-daemon
        state: latest

    - name: Ensure powersave profile daemon is enabled and started
      ansible.builtin.systemd:
        name: power-profiles-daemon
        state: started
        enabled: yes

    - name: Ensure powersaving related packages are installed
      pacman:
        state: latest
        name: "{{ packages }}"
      vars:
        packages:
          - 'powertop'
          - 'ethtool'
          - 'x86_energy_perf_policy'
