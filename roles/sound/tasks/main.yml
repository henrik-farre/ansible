- name: Configure alsa+pipewire system wide
  become: true
  tags:
    - sound
  block:
    - name: Ensure alsa-utils are installed
      community.general.pacman:
        name: "{{ packages }}"
        state: latest
      vars:
        packages:
          - alsa-lib
          - alsa-tools
          - alsa-utils

    - name: Ensure asound.state exists
      ansible.builtin.command: alsactl store
      args:
        creates: /var/lib/alsa/asound.state
      when:
        - ansible_virtualization_type != 'virtualbox'

    - name: Ensure alsa-restore service is started
      ansible.builtin.systemd:
        name: alsa-restore
        state: started
        enabled: yes

    - name: Ensure pipewire is installed
      community.general.pacman:
        name: "{{ packages }}"
        state: latest
      vars:
        packages:
          - pipewire
          - pipewire-pulse
          - pipewire-alsa
          - wireplumber

    - name: Get the list of services
      ansible.builtin.service_facts:

    - name: Ensure old pulseaudio services are disabled
      ansible.builtin.systemd:
        enabled: no
        state: stopped
        name: "{{ item }}"
      when: item in services
      loop:
        - pulseaudio.socket
        - pulseaudio.service

    - name: Ensure pulseaudio related packages are uninstalled
      community.general.pacman:
        name: "{{ packages }}"
        state: absent
      vars:
        packages:
          - pulseaudio-alsa
          - pulseaudio
          - pulseaudio-modules-bt-git
          - pulseaudio-bluetooth

- name: Ensure wireplumber config directory exists
  ansible.builtin.file:
    path: "{{ ansible_user_dir }}/.config/wireplumber/main.lua.d/"
    state: directory
    mode: 0750
  tags:
    - sound

- name: Ensure USB audio in Thinkpad dock is disabled
  ansible.builtin.copy:
    dest: "{{ ansible_user_dir }}/.config/wireplumber/main.lua.d/51-alsa-disable.lua"
    content: |
      rule = {
        matches = {
          {
            { "device.name", "equals", "alsa_card.usb-Lenovo_ThinkPad_Thunderbolt_3_Dock_USB_Audio_000000000000-00" },
          },
        },
        apply_properties = {
          ["device.disabled"] = true,
        },
      }

      table.insert(alsa_monitor.rules,rule)
    mode: 0640
  tags:
    - sound
