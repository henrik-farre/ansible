---
- name: Ensure bluetooth packages are installed
  become: yes
  pacman:
    state: latest
    name: "{{ packages }}"
  vars:
    packages:
      - bluez
      - bluez-utils
      - bluez-tools
      - blueman
  tags:
    - bluetooth

- name: Ensure pulseaudio bluetooth support is installed
  become: yes
  pacman:
    state: latest
    name: "{{ bluetooth.pulseaudio_bt.packages }}"
  when:
    - not bluetooth.pulseaudio_bt.packages_from_aur
  tags:
    - bluetooth

- name: Ensure pulseaudio bluetooth support is installed
  become: yes
  become_user: aur_builder
  aur:
    name: "{{ bluetooth.pulseaudio_bt.packages }}"
  when:
    - bluetooth.pulseaudio_bt.packages_from_aur
  tags:
    - bluetooth

- name: Ensure bluetooth is enabled
  become: yes
  lineinfile:
    name: /etc/bluetooth/main.conf
    regexp: 'AutoEnable='
    line: 'AutoEnable=true'
    state: present
  tags:
    - bluetooth

- name: Ensure bluetooth service is started
  become: yes
  systemd:
    name: bluetooth
    state: started
    enabled: yes
  tags:
    - bluetooth

- name: Ensure newly-conneced devices are auto connected
  become: yes
  blockinfile:
    path: /etc/pulse/default.pa
    block: |
      # automatically switch to newly-connected devices
      load-module module-switch-on-connect
    state: present
  tags:
    - bluetooth

# Test command: dbus-send --print-reply --dest=org.mpris.MediaPlayer2.spotify /org/mpris/MediaPlayer2 org.mpris.MediaPlayer2.Player.PlayPause
#
# - Looks like it is not needed anymore
#
#- name: Allow access to dbus org.mpris interface
#  become: yes
#  lineinfile:
#    name: /etc/dbus-1/system.d/bluetooth.conf
#    line: '    <allow send_destination="org.mpris"/>'
#    insertafter: '<policy group="lp">'
#    state: present
#  tags:
#    - bluetooth
- name: Cleanup old bluetooth.conf.* files
  become: yes
  file:
    path: "{{ item }}"
    state: absent
  loop:
    - /etc/dbus-1/system.d/bluetooth.conf.pacnew
    - /etc/dbus-1/system.d/bluetooth.conf.pacsave
  tags:
    - bluetooth

- name: Allow useers in the wheel group to access blueman funtionality
  become: yes
  copy:
    dest: /etc/polkit-1/rules.d/99-blueman.rules
    content: |
      /* Managed by Ansible */
      /* Allow users in wheel group to use blueman feature requiring root without authentication */
      polkit.addRule(function(action, subject) {
          if ((action.id == "org.blueman.network.setup" ||
              action.id == "org.blueman.dhcp.client" ||
              action.id == "org.blueman.rfkill.setstate" ||
              action.id == "org.blueman.pppd.pppconnect") &&
              subject.isInGroup("wheel")) {
              return polkit.Result.YES;
          }
      });
  tags:
    - bluetooth

# https://www.reddit.com/r/linux/comments/at0zo0/til_that_since_2017_its_possible_in_pulseaudio_to/
# https://github.com/pastleo/fix-bt-a2dp
# https://github.com/EHfive/pulseaudio-modules-bt/issues/14
# a2dp-fix has to be executable as the user running pulseaudio
- name: Ensure a2dp fix scripts are in place
  become: yes
  copy:
    dest: "/{{ item }}"
    src: "{{ item }}"
    group: root
    mode: 0755
    owner: root
  loop:
    - "usr/local/sbin/a2dp-fix-wrapper"
    - "usr/local/sbin/a2dp-fix"
  tags:
    - bluetooth

- name: Ensure udev rule is in place
  become: yes
  copy:
    dest: "/etc/udev/rules.d/80-bt-headset.rules"
    src: "etc/udev/rules.d/80-bt-headset.rules"
    group: root
    mode: 0640
    owner: root
  tags:
    - bluetooth
