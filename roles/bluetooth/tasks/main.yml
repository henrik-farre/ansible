---
- name: Ensure bluetooth is enabled
  become: yes
  lineinfile:
    name: /etc/bluetooth/main.conf
    regexp: 'AutoEnable='
    line: 'AutoEnable=true'
    state: present
  tags:
    - bluetooth

- name: Ensure newly-conneced devices are auto connected
  become: yes
  blockinfile:
    path: /etc/pulse/default.pa
    block: |
      # automatically switch to newly-connected devices
      load-module module-switch-on-connect
    state: present
  tags:
    - bluetooth

- name: Allow access to dbus org.mpris interface
  become: yes
  lineinfile:
    name: /etc/dbus-1/system.d/bluetooth.conf
    line: '    <allow send_destination="org.mpris"/>'
    insertafter: '<policy group="lp">'
    state: present
  tags:
    - bluetooth

- name: Allow useers in the wheel group to access blueman funtionality
  become: yes
  copy:
    dest: /etc/polkit-1/rules.d/99-blueman.rules
    content: |
      /* Managed by Ansible */
      /* Allow users in wheel group to use blueman feature requiring root without authentication */
      polkit.addRule(function(action, subject) {
          if ((action.id == "org.blueman.network.setup" ||
              action.id == "org.blueman.dhcp.client" ||
              action.id == "org.blueman.rfkill.setstate" ||
              action.id == "org.blueman.pppd.pppconnect") &&
              subject.isInGroup("wheel")) {
              return polkit.Result.YES;
          }
      });
  tags:
    - bluetooth
