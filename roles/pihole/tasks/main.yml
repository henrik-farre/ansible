---
- name: Ensure pihole is installed and configured
  become: true
  tags:
    - pihole
  block:
    - name: Ensure vaulted vars are loaded
      ansible.builtin.include_vars:
        file: pihole.yml.vault

    # Needed for piholes "installLogrotate" as it uses group to create logrotate config
    - name: Ensure needed directories exist
      ansible.builtin.file:
        path: "/srv/pihole/{{ item.path }}"
        state: directory
        mode: 0775
        owner: "{{ item.owner }}"
        group: "{{ item.group }}"
      loop:
        - path: data/etc/pihole
          owner: 999
          group: 999
        - path: data/etc/dnsmasq.d
          owner: root
          group: root
        - path: data/var/log
          owner: root
          group: root
        - path: data/var/log/lighttpd
          owner: 33
          group: 33
        - path: data/backup
          owner: 33
          group: 33
        - path: deploy
          owner: root
          group: docker
        - path: scripts
          owner: root
          group: docker

    - name: Ensure macvlan docker network exists
      community.docker.docker_network:
        name: macvlan
        driver: macvlan
        driver_options:
          parent: "{{ ansible_facts.default_ipv4.interface }}"
        ipam_driver: "default"
        ipam_config:
          - subnet: "{{ ansible_facts.default_ipv4.network }}/{{ ansible_facts.default_ipv4.prefix }}"
            gateway: "{{ ansible_facts.default_ipv4.gateway }}"
        state: "present"

    - name: Ensure systemd unit to configure routing exists
      ansible.builtin.copy:
        dest: /usr/local/lib/systemd/system/macvlan-configure.service
        mode: 0664
        content: |
          [Unit]
          Description=Configure Macvlan routing
          OnFailure=status-email@%n.service

          [Service]
          Type=oneshot
          ExecStart=ip link add macvlan link {{ ansible_facts.default_ipv4.interface }} type macvlan mode bridge
          ExecStart=ip address add 192.168.0.100/32 dev macvlan
          ExecStart=ip link set macvlan up
          ExecStart=ip route add {{ pihole.local_ipv4 }}/32 dev macvlan

          [Install]
          WantedBy=multi-user.target

    - name: Ensure macvlan-configure is enabled
      ansible.builtin.systemd_service:
        name: macvlan-configure
        enabled: true

    - name: Ensure docker-compose.yml exists for pihole
      ansible.builtin.template:
        src: docker-compose.yml.j2
        dest: /srv/pihole/deploy/docker-compose.yml
        mode: 0664
        owner: root
        group: docker

    # Remember to restore backup after startup
    - name: Deploy Docker Compose stack
      community.docker.docker_compose_v2:
        project_name: pihole
        project_src: /srv/pihole/deploy

    - name: Configure host to use pihole for DNS
      ansible.builtin.copy:
        dest: /etc/resolv.conf
        content: |
          search {{ network.local_domain }}
          nameserver {{ pihole.local_ipv4 }}
        mode: 0644
        owner: root
        group: root

    - name: Pihole | Update gravity | systemd service
      ansible.builtin.copy:
        dest: /usr/local/lib/systemd/system/pihole-updategravity.service
        content: |
          [Unit]
          Description=Pi-hole: Update the ad sources
          OnFailure=status-email@%n.service

          [Service]
          Type=oneshot
          ExecStart=/usr/bin/docker exec pihole pihole updateGravity > /dev/null
        owner: root
        mode: 0644

    - name: Pihole | Update gravity | systemd timer
      ansible.builtin.copy:
        dest: /usr/local/lib/systemd/system/pihole-updategravity.timer
        content: |
          [Unit]
          Description=Pi-hole: Update the ad sources | Weekly job

          [Timer]
          OnCalendar=Sun 23:59:00
          Persistent=true

          [Install]
          WantedBy=timers.target
        owner: root
        mode: 0644

    - name: Pihole | Flush log | systemd service
      ansible.builtin.copy:
        dest: /usr/local/lib/systemd/system/pihole-flushlog.service
        content: |
          [Unit]
          Description=Pi-hole: Flush the log
          OnFailure=status-email@%n.service

          [Service]
          Type=oneshot
          ExecStart=/usr/bin/docker exec pihole pihole flush once > /dev/null
        owner: root
        mode: 0644

    - name: Pihole | Flush log | systemd timer
      ansible.builtin.copy:
        dest: /usr/local/lib/systemd/system/pihole-flushlog.timer
        content: |
          [Unit]
          Description=Pi-hole: Flush the log | Daily job

          [Timer]
          OnCalendar=23:00:00
          Persistent=true

          [Install]
          WantedBy=timers.target
        owner: root
        mode: 0644

    - name: Install pihole backup script
      ansible.builtin.copy:
        dest: /srv/pihole/scripts/backup-pihole.sh
        content: |
          #!/bin/bash
          set -o nounset
          set -o errexit
          set -o pipefail

          BACKUP_LOCATION=/shared/backup/pihole/$(date +"%Y-%m-%d")

          mkdir -p "$BACKUP_LOCATION"

          /usr/bin/docker exec pihole pihole -a -t /backup/teleporter.tar.gz

          mv /srv/pihole/data/backup/teleporter.tar.gz "${BACKUP_LOCATION}"
        mode: 0750

    - name: Install systemd services for backup
      ansible.builtin.copy:
        dest: /usr/local/lib/systemd/system/backup-pihole.service
        content: |
          [Unit]
          Description=Backup pihole
          OnFailure=status-email@%n.service

          [Service]
          WorkingDirectory=/srv/pihole/deploy

          Type=oneshot
          ExecStart=/srv/pihole/scripts/backup-pihole.sh
        owner: root
        mode: 0644

    - name: Install systemd timers
      ansible.builtin.copy:
        dest: /usr/local/lib/systemd/system/backup-pihole.timer
        content: |
          [Unit]
          Description=Backup pihole
          After=network-online.target
          Wants=network-online.target

          [Timer]
          OnCalendar=daily
          Persistent=True

          [Install]
          WantedBy=timers.target
        owner: root
        mode: 0644

    - name: Reload systemd
      ansible.builtin.systemd:
        daemon_reload: yes

    - name: Enable systemd services
      ansible.builtin.systemd:
        name: "{{ item }}"
        enabled: yes
      loop:
        - pihole-updategravity.service
        - pihole-flushlog.service
        - backup-pihole.service

    - name: Enable systemd timers
      ansible.builtin.systemd:
        name: "{{ item }}"
        enabled: yes
        state: started
      loop:
        - pihole-updategravity.timer
        - pihole-flushlog.timer
        - backup-pihole.timer
