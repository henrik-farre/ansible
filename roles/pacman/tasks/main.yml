- name: Become and tag block
  become: yes
  tags:
    - pacman
  block:
    - name: Include tasks to cleanup old ansible
      include_tasks: cleanup.yml

    - name: Enable multilib repo in pacman - part 1
      lineinfile:
        path: /etc/pacman.conf
        regexp: '\[multilib\]'
        line: "[multilib]"
        state: present
      register: multilib_update

    - name: Enable multilib repo in pacman - part 2
      lineinfile:
        path: /etc/pacman.conf
        regexp: 'Include '
        line: "Include = /etc/pacman.d/mirrorlist"
        insertafter: "[multilib]"
        state: present

    - name: Ensure parallel downloads are enabled
      lineinfile:
        path: /etc/pacman.conf
        regexp: '.*ParallelDownloads = .*'
        line: "ParallelDownloads = 5"
        state: present

    - name: Ensure color is enabled
      lineinfile:
        path: /etc/pacman.conf
        regexp: '.*Color'
        line: "Color"
        state: present

    - name: Update pacman cache
      pacman:
        update_cache: yes
      when:
        - multilib_update.changed

    - name: Ensure needed pacman contrib utilies are installed
      pacman:
        state: latest
        name: "{{ packages }}"
      vars:
        packages:
          - pacman-contrib
          - reflector

    - name: Ensure local systemd directory exists
      file:
        state: directory
        path: /usr/local/lib/systemd/system
        mode: 0755

    - name: Pacman cache | Remove uninstalled and old packages | systemd service
      copy:
        dest: /usr/local/lib/systemd/system/pacman-cache-cleanup.service
        content: |
          [Unit]
          Description=Pacman cache cleanup cache
          OnFailure=status-email@%n.service

          [Service]
          Type=oneshot
          ExecStart=/usr/bin/paccache --remove --verbose --uninstalled --keep 0 ; /usr/bin/paccache --remove --verbose --keep 2
        owner: root
        mode: 0644

    - name: Pacman cache | Remove uninstalled and old packages | systemd timer
      copy:
        dest: /usr/local/lib/systemd/system/pacman-cache-cleanup.timer
        content: |
          [Unit]
          Description=Pacman cache cleanup cache | Weekly job

          [Timer]
          OnCalendar=weekly
          Persistent=true

          [Install]
          WantedBy=timers.target
        owner: root
        mode: 0644

    - name: Reload systemd
      systemd:
        daemon_reload: yes

    - name: Enable systemd services
      systemd:
        name: "pacman-cache-cleanup.service"
        enabled: yes

    - name: Enable systemd timers
      systemd:
        name: "pacman-cache-cleanup.timer"
        enabled: yes
        state: started

    - name: Ensure pacman hook directory exist
      file:
        path: /etc/pacman.d/hooks
        state: directory
        owner: root
        mode: 0750

    # No need to update mirrorlist on changes to mirrorlist - just enable timer
    # https://wiki.archlinux.org/index.php/Reflector#pacman_hook
    - name: Ensure pacman mirrorlist hook is absent
      file:
        path: /etc/pacman.d/hooks/mirrorupgrade.hook
        state: absent

    - name: Reflector config
      lineinfile:
        path: /etc/xdg/reflector/reflector.conf
        state: present
        regexp: '--country'
        line: '--country Denmark,Germany,Norway,Sweden,Ireland,Netherlands'

    - name: Reflector config
      lineinfile:
        path: /etc/xdg/reflector/reflector.conf
        state: present
        regexp: '--sort'
        line: '--sort rate'

    - name: Enable systemd timers
      systemd:
        name: "reflector.timer"
        enabled: yes
        state: started
