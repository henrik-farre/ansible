---
- name: Ensure that the ~/.config/conky directory exists
  file:
    path: "{{ ansible_user_dir }}/.config/conky"
    owner: "{{ ansible_user_id }}"
    state: directory
    mode: 0700
  tags:
    - conky

- name: Ensure that the ~/.config/autostart directory exists
  file:
    path: "{{ ansible_user_dir }}/.config/autostart"
    owner: "{{ ansible_user_id }}"
    state: directory
    mode: 0700
  tags:
    - conky

- name: Write ~/.config/conky/conkyrc
  template:
    src: conkyrc.j2
    dest: "{{ ansible_user_dir }}/.config/conky/conkyrc"
    owner: "{{ ansible_user_id }}"
    mode: 0644
  tags:
    - conky

- name: Ensure conky is autostated
  copy:
    content: |
      [Desktop Entry]
      Name=Conky
      Exec=/usr/bin/conky -c "{{ ansible_user_dir }}/.config/conky/conkyrc"
      Type=Application
    dest: "{{ ansible_user_dir }}/.config/autostart/conky.desktop"
    owner: "{{ ansible_user_id }}"
  tags:
    - conky

- name: Check if FontAwesome is installed
  stat:
    path: "{{ ansible_user_dir }}/.local/share/fonts/fontawesome-webfont.ttf"
  register: font_stat
  tags:
    - conky

- block:
    - name: Download and extract FontAwesome 4.7
      unarchive:
        src: https://fontawesome.com/v4.7.0/assets/font-awesome-4.7.0.zip
        dest: "/tmp/"
        remote_src: True
      when:
        - font_stat.stat.exists is defined and font_stat.stat.exists == false
      tags:
        - conky

    - name: Install FontAwesome
      copy:
        src: "/tmp/font-awesome-4.7.0/fonts/fontawesome-webfont.ttf"
        dest: "{{ ansible_user_dir }}/.local/share/fonts/fontawesome-webfont.ttf"
        remote_src: yes
      when:
        - font_stat.stat.exists is defined and font_stat.stat.exists == false
      notify:
        - Update font cache
      tags:
        - conky

  always:
    - name: Cleanup
      file:
        path: /tmp/font-awesome-4.7.0
        state: absent
      when:
        - font_stat.stat.exists is defined and font_stat.stat.exists == false
      tags:
        - conky
