---
- name: Create .ssh dir
  file:
    dest: "{{ ansible_user_dir }}/.ssh"
    owner: "{{ ansible_user_id }}"
    state: directory
    mode: 0700
  tags:
    - ssh-keys

- name: Install SSH keys
  copy:
    src: "{{ item.src }}"
    dest: "{{ ansible_user_dir }}/.ssh/{{ item.dest }}"
    owner: "{{ ansible_user_id }}"
    mode: 0600
  with_items:
    - { src: "id_rsa.{{ansible_hostname}}.vault", dest: "id_rsa.{{ansible_hostname}}" }
    - { src: "id_rsa.{{ansible_hostname}}.pub", dest: "id_rsa.{{ansible_hostname}}.pub" }
    - { src: "id_rsa.storagebox.vault", dest: "id_rsa.storagebox" }
    - { src: "id_rsa.storagebox.pub", dest: "id_rsa.storagebox.pub" }
    - { src: "id_rsa.bitbucket.vault", dest: "id_rsa.bitbucket" }
    - { src: "id_rsa.bitbucket.pub", dest: "id_rsa.bitbucket.pub" }
    - { src: "id_ed25519.awx.vault", dest: "id_ed25519.awx" }
    - { src: "id_ed25519.awx.pub",   dest: "id_ed25519.awx.pub" }
  tags:
    - ssh-keys

- name: Symlink SSH keys to default
  file:
    src: "{{ ansible_user_dir }}/.ssh/{{ item.src }}"
    dest: "{{ ansible_user_dir }}/.ssh/{{ item.dest }}"
    state: link
  with_items:
    - { src: "id_rsa.{{ansible_hostname}}", dest: "id_rsa" }
    - { src: "id_rsa.{{ansible_hostname}}.pub", dest: "id_rsa.pub" }
  tags:
    - ssh-keys

- name: Set up authorized keys
  authorized_key:
    user: "{{ ansible_user_id }}"
    state: present
    key: "{{ lookup('file', '{{ item }}') }}"
  with_fileglob:
    - "*.pub"
  tags:
    - ssh-keys

- name: Add hosts as known hosts
  known_hosts:
    path: "{{ ansible_user_dir }}/.ssh/known_hosts"
    name: "{{ item }}"
    key: "{{ lookup('pipe', 'ssh-keyscan -t rsa {{ item }}') }}"
  with_items:
    - "github.com"
    - "bitbucket.com"
  tags:
    - ssh-keys
