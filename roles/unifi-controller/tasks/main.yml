---
- name: Ensure all tasks are run with become and correct tag
  block:
    - name: Ensure needed pgp tools are installed
      package:
        name: dirmngr
        state: latest

    # https://community.ubnt.com/t5/UniFi-Updates-Blog/UniFi-SDN-Controller-5-9-29-Stable-has-been-released/ba-p/2516852
    - name: Ensure support java version is installed
      package:
        name: openjdk-8-jre-headless
        state: latest

    - name: Ensure unifi apt key is available
      apt_key:
        keyserver: keyserver.ubuntu.com
        id: 06E85760C0A52C50

    - name: Ensure unifi repository is available
      apt_repository:
        repo: deb http://www.ubnt.com/downloads/unifi/debian stable ubiquiti
        state: present
        filename: 100-ubnt.list

    - name: Update apt cache
      apt:
        update_cache: yes

    - name: Ensure unifi controller is installed
      package:
        name: unifi
        state: latest

    - name: Ensure unsupported lib is removed
      file:
        path: /usr/lib/unifi/lib/native/Linux/armhf/libubnt_webrtc_jni.so
        state: absent
      when:
        - ansible_facts.architecture == "armv6l"

    - name: Ensure mongodb is stopped and disabled
      service:
        name: mongodb
        state: stopped
        enabled: no

    # https://help.ubnt.com/hc/en-us/articles/215458888-UniFi-How-to-further-customize-USG-configuration-with-config-gateway-json
    - name: Ensure custom config.gateway.json is deployed
      copy:
        content: "{{ unifi.config_gateway|to_nice_json }}"
        dest: /usr/lib/unifi/data/sites/default/config.gateway.json
        owner: unifi
        group: unifi
        mode: 0600
      when:
        - unifi.config_gateway is defined

    - name: Ensure unifi service is started and enabled
      service:
        name: unifi
        state: started
        enabled: yes
  # Block level
  become: yes
  tags:
    - unifi-controller
