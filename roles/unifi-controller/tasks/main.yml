---
- name: Ensure needed pgp tools are installed
  become: yes
  package:
    name: dirmngr
    state: latest
  tags:
    - unifi-controller

- name: Ensure unifi apt key is available
  become: yes
  apt_key:
    keyserver: keyserver.ubuntu.com
    id: 06E85760C0A52C50
  tags:
    - unifi-controller

- name: Ensure unifi repository is available
  become: yes
  apt_repository:
    repo: deb http://www.ubnt.com/downloads/unifi/debian stable ubiquiti
    state: present
    filename: 100-ubnt.list
  tags:
    - unifi-controller

- name: Update apt cache
  become: yes
  apt:
    update_cache: yes
  tags:
    - unifi-controller

- name: Ensure unifi controller is installed
  become: yes
  package:
    name: unifi
    state: latest
  tags:
    - unifi-controller

- name: Ensure unsupported lib is removed
  become: yes
  file:
    path: /usr/lib/unifi/lib/native/Linux/armhf/libubnt_webrtc_jni.so
    state: absent
  tags:
    - unifi-controller

- name: Ensure unneeded services are stopped and disabled
  become: yes
  service:
    name: "{{ item }}"
    state: stopped
    enabled: no
  with_items:
    - triggerhappy
    - triggerhappy.socket
    - avahi-daemon
    - mongodb
    - rsyslog.service
    - syslog.socket
    - alsa-restore.service
    - dphys-swapfile.service
  tags:
    - unifi-controller

# https://help.ubnt.com/hc/en-us/articles/215458888-UniFi-How-to-further-customize-USG-configuration-with-config-gateway-json
- name: Ensure custom config.gateway.json is deployed
  become: yes
  copy:
    content: "{{ unifi.config_gateway|to_nice_json }}"
    dest: /usr/lib/unifi/data/sites/default/config.gateway.json
    owner: unifi
    group: unifi
    mode: 0600
  when:
    - unifi.config_gateway is defined
  tags:
    - unifi-controller

- name: Ensure unifi service is started and enabled
  become: yes
  service:
    name: unifi
    state: started
    enabled: yes
  tags:
    - unifi-controller
