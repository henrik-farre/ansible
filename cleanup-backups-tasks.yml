---
- name: "Find files in {{ task.path }}"
  ansible.builtin.find:
    paths: "{{ task.path }}"
    recurse: "{{ task.recurse|default(false) }}"
    depth: "{{ task.depth|default(omit) }}"
    file_type: "{{ task.file_type }}"
    pattern: "{{ task.pattern|default(omit) }}"
    age: "{{ task.age|default(omit) }}"
  register: files_found

- name: Debug
  ansible.builtin.debug:
    var: task

- name: Debug 2
  ansible.builtin.debug:
    var: files_found

- name: Delete files
  ansible.builtin.file:
    path: "{{ item.path }}"
    state: absent
  loop: "{{ (files_found.files | sort(attribute='ctime', reverse=True))[task.keep:] }}"

- name: Calculate total size of old files
  set_fact:
    total_saved_bytes: "{{ (files_found.files | sort(attribute='ctime', reverse=True))[task.keep:] | map(attribute='size') | sum }}"

- name: Show total disk space saved
  debug:
    msg: "Cleaned {{ (total_saved_bytes / 1024 / 1024) | round(2) }} MB of disk space."
  when: total_saved_bytes > 0
